<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="184,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T6U3">bLeaf</span>, <span class="var type1" id="S3T105U4">bLessThanTrain</span>, <span class="var type1" id="S4T106U5">partitionPoint</span>, <span class="var type1" id="S5T46U6">projMat</span>, <span class="var type1" id="S6T107U7">countsNode</span>, <span class="var type1" id="S7T51U8">iIn</span>] = expandNode(<span class="var type1" id="S8T52U11">XTrain</span>,<span class="var type1" id="S9T1U12">YTrain</span>,<span class="var type1" id="S10T55U13">options</span>,<span class="var type1" id="S11T51U14">iFeatureNum</span>,<span class="var type1" id="S12T4U15">depth</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="184,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,3" id="srcline3">  3</a></span><span class="line"><span class="mxinfo" id="T105:U12"><span class="var type1" id="S3T105U18">bLessThanTrain</span> = <span class="mxinfo" id="T66:U14"><span class="mxinfo" id="T6:U15">false</span>(<span class="mxinfo" id="T4:U16">0</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,4" id="srcline4">  4</a></span><span class="line"><span class="mxinfo" id="T106:U17"><span class="var type1" id="S4T106U25">partitionPoint</span> = <span class="mxinfo" id="T4:U19">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,5" id="srcline5">  5</a></span><span class="line"><span class="mxinfo" id="T46:U20"><span class="var type1" id="S5T46U29">projMat</span> = <span class="mxinfo" id="T38:U22">zeros(<span class="mxinfo" id="T4:U23">0</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,6" id="srcline6">  6</a></span><span class="line"><span class="mxinfo" id="T51:U24"><span class="var type1" id="S7T51U36">iIn</span> = <span class="mxinfo" id="T35:U26">zeros(<span class="mxinfo" id="T4:U27">1</span>,<span class="mxinfo" id="T4:U28">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,7" id="srcline7">  7</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T6:U29"><span class="mxinfo" id="T4:U30">size(<span class="var type1" id="S9T1U46">YTrain</span>,2)</span>==<span class="mxinfo" id="T4:U32">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,8" id="srcline8">  8</a></span><span class="line">    <span class="mxinfo" id="T107:U33"><span class="var type1" id="S6T107U51">countsNode</span> = <span class="mxinfo" id="T146:U35">[<span class="mxinfo" id="T112:U36"><span class="mxinfo" id="T4:U37">numel(<span class="var type1" id="S9T1U57">YTrain</span>)</span>-<span class="mxinfo" id="T112:U39">sum(<span class="var type1" id="S9T1U60">YTrain</span>)</span></span>,<span class="mxinfo" id="T112:U41">sum(<span class="var type1" id="S9T1U63">YTrain</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,9" id="srcline9">  9</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,10" id="srcline10"> 10</a></span><span class="line">    <span class="mxinfo" id="T107:U43"><span class="var type1" id="S6T107U67">countsNode</span> = <span class="mxinfo" id="T51:U45">sum(<span class="var type1" id="S9T1U70">YTrain</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,11" id="srcline11"> 11</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,12" id="srcline12"> 12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo" id="T4:U47"><span class="var type1" id="S18T4U74">N</span> = <span class="mxinfo" id="T4:U49">size(<span class="var type1" id="S8T52U77">XTrain</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% Return if one training point, pure node or if options for returning</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">% fulfilled.  A little case to deal with a binary YTrain is required.</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo" id="T6:U51"><span class="var type1" id="S2T6U81">bLeaf</span> = <span class="mxinfo" id="T6:U53">(<span class="mxinfo" id="T6:U54"><span class="var type1" id="S18T4U85">N</span>&lt;(<span class="mxinfo" id="T4:U56">max(<span class="mxinfo" id="T4:U57">2</span>,<span class="mxinfo" id="T4:U58"><span class="var type1" id="S10T55U91">options</span>.minPointsForSplit</span>)</span>)</span>) || <span class="mxinfo" id="T6:U60"><span class="var type1" id="S12T4U94">depth</span>&gt;<span class="mxinfo" id="T4:U62"><span class="var type1" id="S10T55U96">options</span>.maxDepthSplit</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,17" id="srcline17"> 17</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,18" id="srcline18"> 18</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T6:U64">~<span class="var type1" id="S2T6U101">bLeaf</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,19" id="srcline19"> 19</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U66"><span class="mxinfo" id="T4:U67">size(<span class="var type1" id="S9T1U107">YTrain</span>,2)</span>&gt;<span class="mxinfo" id="T4:U69">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,20" id="srcline20"> 20</a></span><span class="line">        <span class="mxinfo" id="T6:U70"><span class="var type1" id="S2T6U112">bLeaf</span> = (<span class="mxinfo" id="T6:U72"><span class="mxinfo" id="T4:U73">sum(<span class="mxinfo" id="T108:U74"><span class="mxinfo" id="T107:U75">abs(<span class="mxinfo" id="T51:U76">sum(<span class="var type1" id="S9T1U122">YTrain</span>,1)</span>)</span>&gt;<span class="mxinfo" id="T4:U78">1e-12</span></span>)</span>&lt;<span class="mxinfo" id="T4:U79">2</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,21" id="srcline21"> 21</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,22" id="srcline22"> 22</a></span><span class="line">        <span class="mxinfo" id="T6:U80"><span class="var type1" id="S2T6U129">bLeaf</span> = <span class="mxinfo" id="T6:U82">any(<span class="mxinfo" id="T75:U83">bsxfun(@eq,<span class="mxinfo" id="T4:U84">sum(<span class="mxinfo" id="T45:U85"><span class="var type1" id="S9T1U139">YTrain</span>(:)</span>)</span>,<span class="mxinfo" id="T16:U87">[<span class="mxinfo" id="T4:U88">0</span>,<span class="mxinfo" id="T4:U89">size(<span class="var type1" id="S9T1U146">YTrain</span>,1)</span>]</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,23" id="srcline23"> 23</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,24" id="srcline24"> 24</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,26" id="srcline26"> 26</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S2T6U150">bLeaf</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,27" id="srcline27"> 27</a></span><span class="line">    <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,28" id="srcline28"> 28</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">%% Subsample features as required for hyperplane sampling</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,32" id="srcline32"> 32</a></span><span class="line"><span class="mxinfo" id="T35:U92"><span class="var type1" id="S7T35U154">iIn</span> = <span class="mxinfo" id="T35:U94">zeros(<span class="mxinfo" id="T4:U95">1</span>,<span class="mxinfo" id="T4:U96">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo" id="T70:U97"><span class="var type1" id="S24T70U161">XTrainBag</span> = <span class="mxinfo" id="T70:U99">zeros(<span class="mxinfo" id="T4:U100">0</span>,<span class="mxinfo" id="T4:U101">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,34" id="srcline34"> 34</a></span><span class="line"><span class="mxinfo" id="T70:U102"><span class="var type1" id="S25T70U168">YTrainBag</span> = <span class="mxinfo" id="T70:U104">zeros(<span class="mxinfo" id="T4:U105">0</span>,<span class="mxinfo" id="T4:U106">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,35" id="srcline35"> 35</a></span><span class="line"><span class="mxinfo" id="T51:U107"><span class="var type1" id="S26T51U175">iCanBeSelected</span> = <span class="mxinfo" id="T51:U109"><span class="fcn" id="F288N4:B177">fastUnique</span>(<span class="var type1" id="S11T51U178">iFeatureNum</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo" id="T51:U111"><span class="var type1" id="S26T51U182">iCanBeSelected</span>(<span class="mxinfo" id="T73:U113">isnan(<span class="var type1" id="S26T51U185">iCanBeSelected</span>)</span>)=[]</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,37" id="srcline37"> 37</a></span><span class="line"><span class="mxinfo" id="T4:U115"><span class="var type1" id="S29T4U190">lambda</span> = <span class="mxinfo" id="T4:U117">min(<span class="mxinfo" id="T4:U118">numel(<span class="var type1" id="S26T51U195">iCanBeSelected</span>)</span>,<span class="mxinfo" id="T4:U120"><span class="var type1" id="S10T55U197">options</span>.lambda</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,38" id="srcline38"> 38</a></span><span class="line"><span class="mxinfo" id="T51:U122"><span class="var type1" id="S31T51U201">indFeatIn</span> = <span class="mxinfo" id="T51:U124">randperm(<span class="mxinfo" id="T4:U125">numel(<span class="var type1" id="S26T51U206">iCanBeSelected</span>)</span>,<span class="var type1" id="S29T4U207">lambda</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,39" id="srcline39"> 39</a></span><span class="line"><span class="mxinfo" id="T51:U128"><span class="var type1" id="S33T51U210">iFeatIn</span> = <span class="mxinfo" id="T51:U130"><span class="var type1" id="S26T51U212">iCanBeSelected</span>(<span class="var type1" id="S31T51U213">indFeatIn</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,40" id="srcline40"> 40</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,41" id="srcline41"> 41</a></span><span class="line"><span class="mxinfo" id="T60:U133"><span class="var type1" id="S34T60U216">bInMat</span> = <span class="mxinfo" id="T60:U135">bsxfun(@eq,<span class="mxinfo" id="T51:U136"><span class="mxinfo" id="T46:U137"><span class="var type1" id="S11T51U223">iFeatureNum</span>(:)</span>'</span>,<span class="mxinfo" id="T46:U139">sort(<span class="mxinfo" id="T46:U140"><span class="var type1" id="S33T51U228">iFeatIn</span>(:)</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,42" id="srcline42"> 42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo" id="T51:U142"><span class="var type1" id="S7T51U232">iIn</span> = <span class="mxinfo" id="T51:U144">find(<span class="mxinfo" id="T73:U145">any(<span class="var type1" id="S34T60U237">bInMat</span>,1)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,44" id="srcline44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,45" id="srcline45"> 45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,46" id="srcline46"> 46</a></span><span class="line"><span class="comment">% Check for variation along selected dimensions and resample features that</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% have no variation</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,48" id="srcline48"> 48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,49" id="srcline49"> 49</a></span><span class="line"><span class="mxinfo" id="T73:U147"><span class="var type1" id="S37T73U241">bXVaries</span> = <span class="mxinfo" id="T73:U149"><span class="fcn" id="F380N8:B243">queryIfColumnsVary</span>(<span class="mxinfo" id="T52:U150"><span class="var type1" id="S8T52U245">XTrain</span>(:,<span class="var type1" id="S7T51U247">iIn</span>)</span>,<span class="mxinfo" id="T4:U153"><span class="var type1" id="S10T55U249">options</span>.XVariationTol</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,50" id="srcline50"> 50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,51" id="srcline51"> 51</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T6:U155">~<span class="mxinfo" id="T6:U156">all(<span class="var type1" id="S37T73U256">bXVaries</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,52" id="srcline52"> 52</a></span><span class="line">    <span class="mxinfo" id="T51:U158"><span class="var type1" id="S40T51U259">iInNew</span> = <span class="var type1" id="S7T51U260">iIn</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,53" id="srcline53"> 53</a></span><span class="line">    <span class="mxinfo" id="T4:U161"><span class="var type1" id="S41T4U263">nSelected</span> = <span class="mxinfo" id="T4:U163">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,54" id="srcline54"> 54</a></span><span class="line">    <span class="mxinfo" id="T51:U164"><span class="var type1" id="S7T51U267">iIn</span> = <span class="mxinfo" id="T51:U166"><span class="var type1" id="S7T51U269">iIn</span>(<span class="var type1" id="S37T73U270">bXVaries</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,55" id="srcline55"> 55</a></span><span class="line">    <span class="keyword">while</span> <span class="mxinfo" id="T6:U169">~<span class="mxinfo" id="T6:U170">all(<span class="var type1" id="S37T73U276">bXVaries</span>)</span></span> &amp;&amp; <span class="mxinfo" id="T6:U172"><span class="var type1" id="S29T4U278">lambda</span>&gt;<span class="mxinfo" id="T4:U174">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,56" id="srcline56"> 56</a></span><span class="line">        <span class="mxinfo" id="T51:U175"><span class="mxinfo" id="T51:U176"><span class="var type1" id="S11T51U283">iFeatureNum</span>(<span class="mxinfo" id="T51:U178"><span class="var type1" id="S40T51U285">iInNew</span>(<span class="mxinfo" id="T73:U180">~<span class="var type1" id="S37T73U287">bXVaries</span></span>)</span>)</span> = <span class="mxinfo" id="T4:U182">NaN</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,57" id="srcline57"> 57</a></span><span class="line">        <span class="mxinfo" id="T60:U183"><span class="mxinfo" id="T60:U184"><span class="var type1" id="S34T60U293">bInMat</span>(:,<span class="mxinfo" id="T51:U186"><span class="var type1" id="S40T51U296">iInNew</span>(<span class="mxinfo" id="T73:U188">~<span class="var type1" id="S37T73U298">bXVaries</span></span>)</span>)</span> = <span class="mxinfo" id="T6:U190">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,58" id="srcline58"> 58</a></span><span class="line">        <span class="mxinfo" id="T45:U191"><span class="var type1" id="S43T45U303">bRemainsSelected</span> = <span class="mxinfo" id="T45:U193">any(<span class="var type1" id="S34T60U306">bInMat</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,59" id="srcline59"> 59</a></span><span class="line">        <span class="mxinfo" id="T4:U195"><span class="var type1" id="S41T4U310">nSelected</span> = <span class="mxinfo" id="T4:U197"><span class="var type1" id="S41T4U312">nSelected</span>+<span class="mxinfo" id="T4:U199">sum(<span class="var type1" id="S43T45U315">bRemainsSelected</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,60" id="srcline60"> 60</a></span><span class="line">        <span class="mxinfo" id="T51:U201"><span class="var type1" id="S26T51U319">iCanBeSelected</span>(<span class="var type1" id="S31T51U320">indFeatIn</span>) = []</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,61" id="srcline61"> 61</a></span><span class="line">        <span class="mxinfo" id="T4:U204"><span class="var type1" id="S29T4U325">lambda</span> = <span class="mxinfo" id="T4:U206">min(<span class="mxinfo" id="T4:U207">numel(<span class="var type1" id="S26T51U330">iCanBeSelected</span>)</span>,<span class="mxinfo" id="T4:U209"><span class="var type1" id="S29T4U332">lambda</span>-<span class="var type1" id="S41T4U333">nSelected</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,62" id="srcline62"> 62</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T6:U212"><span class="var type1" id="S29T4U337">lambda</span>&lt;<span class="mxinfo" id="T4:U214">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,63" id="srcline63"> 63</a></span><span class="line">            <span class="keyword">break</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,64" id="srcline64"> 64</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,65" id="srcline65"> 65</a></span><span class="line">        <span class="mxinfo" id="T51:U215"><span class="var type1" id="S31T51U342">indFeatIn</span> = <span class="mxinfo" id="T51:U217">randperm(<span class="mxinfo" id="T4:U218">numel(<span class="var type1" id="S26T51U347">iCanBeSelected</span>)</span>,<span class="var type1" id="S29T4U348">lambda</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,66" id="srcline66"> 66</a></span><span class="line">        <span class="mxinfo" id="T51:U221"><span class="var type1" id="S33T51U351">iFeatIn</span> = <span class="mxinfo" id="T51:U223"><span class="var type1" id="S26T51U353">iCanBeSelected</span>(<span class="var type1" id="S31T51U354">indFeatIn</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,67" id="srcline67"> 67</a></span><span class="line">        <span class="mxinfo" id="T60:U226"><span class="var type1" id="S34T60U357">bInMat</span> = <span class="mxinfo" id="T60:U228">bsxfun(@eq,<span class="mxinfo" id="T51:U229"><span class="mxinfo" id="T46:U230"><span class="var type1" id="S11T51U364">iFeatureNum</span>(:)</span>'</span>,<span class="mxinfo" id="T46:U232"><span class="var type1" id="S33T51U367">iFeatIn</span>(:)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,68" id="srcline68"> 68</a></span><span class="line">        <span class="mxinfo" id="T51:U234"><span class="var type1" id="S40T51U371">iInNew</span> = <span class="mxinfo" id="T51:U236">find(<span class="mxinfo" id="T73:U237">any(<span class="var type1" id="S34T60U376">bInMat</span>,1)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,69" id="srcline69"> 69</a></span><span class="line">        <span class="mxinfo" id="T73:U239"><span class="var type1" id="S37T73U380">bXVaries</span> = <span class="mxinfo" id="T73:U241"><span class="fcn" id="F380N8:B382">queryIfColumnsVary</span>(<span class="mxinfo" id="T52:U242"><span class="var type1" id="S8T52U384">XTrain</span>(:,<span class="var type1" id="S40T51U386">iInNew</span>)</span>,<span class="mxinfo" id="T4:U245"><span class="var type1" id="S10T55U388">options</span>.XVariationTol</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,70" id="srcline70"> 70</a></span><span class="line">        <span class="mxinfo" id="T51:U247"><span class="var type1" id="S7T51U392">iIn</span> = <span class="mxinfo" id="T51:U249">sort(<span class="mxinfo" id="T51:U250">[<span class="var type1" id="S7T51U397">iIn</span>,<span class="mxinfo" id="T51:U252"><span class="var type1" id="S40T51U399">iInNew</span>(<span class="var type1" id="S37T73U400">bXVaries</span>)</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,71" id="srcline71"> 71</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,72" id="srcline72"> 72</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,73" id="srcline73"> 73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,74" id="srcline74"> 74</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T6:U255">isempty(<span class="var type1" id="S7T51U405">iIn</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,75" id="srcline75"> 75</a></span><span class="line">    <span class="comment">% This means that there was no variation along any feature, therefore</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,76" id="srcline76"> 76</a></span><span class="line">    <span class="comment">% exit.</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,77" id="srcline77"> 77</a></span><span class="line">    <span class="mxinfo" id="T6:U257"><span class="var type1" id="S2T6U408">bLeaf</span> = <span class="mxinfo" id="T6:U259">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,78" id="srcline78"> 78</a></span><span class="line">    <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,79" id="srcline79"> 79</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,80" id="srcline80"> 80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">%% Projection bootstrap if required</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,82" id="srcline82"> 82</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,83" id="srcline83"> 83</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,84" id="srcline84"> 84</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T6:U260"><span class="var type1" id="S10T55U415">options</span>.bProjBoot</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,85" id="srcline85"> 85</a></span><span class="line">    <span class="mxinfo" id="T46:U262"><span class="var type1" id="S46T46U419">iTrainThis</span> = <span class="mxinfo" id="T46:U264">randi(<span class="mxinfo" id="T4:U265">size(<span class="var type1" id="S8T52U424">XTrain</span>,1)</span>,<span class="mxinfo" id="T4:U267">size(<span class="var type1" id="S8T52U428">XTrain</span>,1)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,86" id="srcline86"> 86</a></span><span class="line">    <span class="mxinfo" id="T52:U269"><span class="var type1" id="S24T52U433">XTrainBag</span> = <span class="mxinfo" id="T52:U271"><span class="var type1" id="S8T52U435">XTrain</span>(<span class="var type1" id="S46T46U436">iTrainThis</span>,<span class="var type1" id="S7T51U437">iIn</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo" id="T60:U275"><span class="var type1" id="S25T60U440">YTrainBag</span> = <span class="mxinfo" id="T1:U277"><span class="var type1" id="S9T1U442">YTrain</span>(<span class="var type1" id="S46T46U443">iTrainThis</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,88" id="srcline88"> 88</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,89" id="srcline89"> 89</a></span><span class="line">    <span class="mxinfo" id="T52:U280"><span class="var type1" id="S24T52U448">XTrainBag</span> = <span class="mxinfo" id="T52:U282"><span class="var type1" id="S8T52U450">XTrain</span>(:,<span class="var type1" id="S7T51U452">iIn</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,90" id="srcline90"> 90</a></span><span class="line">    <span class="mxinfo" id="T60:U285"><span class="var type1" id="S25T60U455">YTrainBag</span> = <span class="var type1" id="S9T1U456">YTrain</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,91" id="srcline91"> 91</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,92" id="srcline92"> 92</a></span><span class="line"><span class="mxinfo" id="T73:U288"><span class="var type1" id="S48T73U459">bXBagVaries</span> = <span class="mxinfo" id="T73:U290"><span class="fcn" id="F380N8:B461">queryIfColumnsVary</span>(<span class="var type1" id="S24T52U462">XTrainBag</span>,<span class="mxinfo" id="T4:U292"><span class="var type1" id="S10T55U464">options</span>.XVariationTol</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,93" id="srcline93"> 93</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T6:U294">~<span class="mxinfo" id="T6:U295">any(<span class="var type1" id="S48T73U473">bXBagVaries</span>)</span></span> || (<span class="mxinfo" id="T6:U297"><span class="mxinfo" id="T4:U298">size(<span class="var type1" id="S25T60U479">YTrainBag</span>,2)</span>&gt;<span class="mxinfo" id="T4:U300">1</span></span> &amp;&amp; (<span class="mxinfo" id="T6:U301"><span class="mxinfo" id="T4:U302">sum(<span class="mxinfo" id="T108:U303"><span class="mxinfo" id="T107:U304">abs(<span class="mxinfo" id="T51:U305">sum(<span class="var type1" id="S25T60U491">YTrainBag</span>,1)</span>)</span>&gt;<span class="mxinfo" id="T4:U307">1e-12</span></span>)</span>&lt;<span class="mxinfo" id="T4:U308">2</span></span>)) || (<span class="mxinfo" id="T6:U309"><span class="mxinfo" id="T4:U310">size(<span class="var type1" id="S25T60U500">YTrainBag</span>,2)</span>==<span class="mxinfo" id="T4:U312">1</span></span> &amp;&amp; <span class="mxinfo" id="T6:U313">any(<span class="mxinfo" id="T75:U314">bsxfun(@eq,<span class="mxinfo" id="T4:U315">sum(<span class="mxinfo" id="T45:U316"><span class="var type1" id="S25T60U512">YTrainBag</span>(:)</span>)</span>,<span class="mxinfo" id="T16:U318">[<span class="mxinfo" id="T4:U319">0</span>,<span class="mxinfo" id="T4:U320">size(<span class="var type1" id="S25T60U519">YTrainBag</span>,1)</span>]</span>)</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="184,94" id="srcline94"> 94</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U322">~<span class="mxinfo" id="T6:U323"><span class="var type1" id="S10T55U525">options</span>.bContinueProjBootDegenerate</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,95" id="srcline95"> 95</a></span><span class="line">        <span class="mxinfo" id="T6:U325"><span class="var type1" id="S2T6U529">bLeaf</span> = <span class="mxinfo" id="T6:U327">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,96" id="srcline96"> 96</a></span><span class="line">        <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,97" id="srcline97"> 97</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,98" id="srcline98"> 98</a></span><span class="line">        <span class="mxinfo" id="T52:U328"><span class="var type1" id="S24T52U536">XTrainBag</span> = <span class="mxinfo" id="T52:U330"><span class="var type1" id="S8T52U538">XTrain</span>(:,<span class="var type1" id="S7T51U540">iIn</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,99" id="srcline99"> 99</a></span><span class="line">        <span class="mxinfo" id="T60:U333"><span class="var type1" id="S25T60U543">YTrainBag</span> = <span class="var type1" id="S9T1U544">YTrain</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,100" id="srcline100">100</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,101" id="srcline101">101</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,103" id="srcline103">103</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,104" id="srcline104">104</a></span><span class="line"><span class="keyword">if</span> ~isempty(<span class="var type1" id="S10T67U552">options</span>.projections) &amp;&amp; ((<span class="mxinfo" id="T6:U337"><span class="mxinfo" id="T4:U338">size(<span class="var type1" id="S24T52U560">XTrainBag</span>,1)</span>==<span class="mxinfo" id="T4:U340">2</span></span>) || <span class="mxinfo" id="T6:U341"><span class="fcn" id="F422N9:B564">queryIfOnlyTwoUniqueRows</span>(<span class="var type1" id="S24T52U565">XTrainBag</span>)</span>) <span class="comment">% Check for only having two points</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,105" id="srcline105">105</a></span><span class="line">    <span class="comment">% If there are only two points setup a maximum marginal split between the points</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,106" id="srcline106">106</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,107" id="srcline107">107</a></span><span class="line">    <span class="mxinfo" id="T6:U343">[<span class="var type1" id="S50T6U569">bSplit</span>,<span class="var type1" id="S5T110U570">projMat</span>,<span class="var type1" id="S4T106U571">partitionPoint</span>] = <span class="fcn" id="F464N10:B573">twoPointMaxMarginSplit</span>(<span class="var type1" id="S24T52U574">XTrainBag</span>,<span class="var type1" id="S25T60U575">YTrainBag</span>,<span class="mxinfo" id="T4:U349"><span class="var type1" id="S10T55U577">options</span>.XVariationTol</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,108" id="srcline108">108</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U351">~<span class="var type1" id="S50T6U582">bSplit</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,109" id="srcline109">109</a></span><span class="line">        <span class="mxinfo" id="T6:U353"><span class="var type1" id="S2T6U585">bLeaf</span> = <span class="mxinfo" id="T6:U355">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,110" id="srcline110">110</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,111" id="srcline111">111</a></span><span class="line">        <span class="mxinfo" id="T105:U356"><span class="var type1" id="S3T105U591">bLessThanTrain</span> = <span class="mxinfo" id="T147:U358">(<span class="mxinfo" id="T52:U359"><span class="mxinfo" id="T52:U360"><span class="var type1" id="S8T52U596">XTrain</span>(:,<span class="var type1" id="S7T51U598">iIn</span>)</span>*<span class="var type1" id="S5T52U599">projMat</span></span>)&lt;=<span class="var type1" id="S4T106U600">partitionPoint</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,112" id="srcline112">112</a></span><span class="line">        <span class="mxinfo" id="T4:U365"><span class="var type1" id="S52T4U603">iDir</span> = <span class="mxinfo" id="T4:U367">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,113" id="srcline113">113</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,114" id="srcline114">114</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,115" id="srcline115">115</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,116" id="srcline116">116</a></span><span class="line">    <span class="comment">% Generate the new features as required</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,117" id="srcline117">117</a></span><span class="line">    <span class="mxinfo" id="T73:U368"><span class="var type1" id="S53T73U608">bYpresent</span> = <span class="mxinfo" id="T73:U370">any(<span class="var type1" id="S25T60U611">YTrainBag</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,118" id="srcline118">118</a></span><span class="line">    <span class="mxinfo" id="T60:U372"><span class="var type1" id="S25T60U615">YTrainBag</span> = <span class="mxinfo" id="T60:U374"><span class="var type1" id="S25T60U617">YTrainBag</span>(:,<span class="var type1" id="S53T73U619">bYpresent</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,119" id="srcline119">119</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,120" id="srcline120">120</a></span><span class="line">    <span class="mxinfo" id="T51:U377"><span class="var type1" id="S54T51U622">muX</span> = <span class="mxinfo" id="T51:U379"><span class="mxinfo" id="T51:U380">sum(<span class="var type1" id="S24T52U626">XTrainBag</span>,1)</span>/<span class="mxinfo" id="T4:U382">size(<span class="var type1" id="S24T52U630">XTrainBag</span>,1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,121" id="srcline121">121</a></span><span class="line">    <span class="mxinfo" id="T51:U384"><span class="var type1" id="S55T51U634">muY</span> = <span class="mxinfo" id="T51:U386"><span class="mxinfo" id="T51:U387">sum(<span class="var type1" id="S25T60U638">YTrainBag</span>,1)</span>/<span class="mxinfo" id="T4:U389">size(<span class="var type1" id="S25T60U642">YTrainBag</span>,1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,122" id="srcline122">122</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,123" id="srcline123">123</a></span><span class="line">    <span class="comment">% Subtraction of the mean is common to the process of calculating the</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,124" id="srcline124">124</a></span><span class="line">    <span class="comment">% projection matrices for both CCA and PCA but for computational</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,125" id="srcline125">125</a></span><span class="line">    <span class="comment">% effificently we don't make this translation when actually applying the</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,126" id="srcline126">126</a></span><span class="line">    <span class="comment">% projections</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,127" id="srcline127">127</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,128" id="srcline128">128</a></span><span class="line">    <span class="mxinfo" id="T52:U391"><span class="var type1" id="S24T52U646">XTrainBag</span> = <span class="mxinfo" id="T52:U393">bsxfun(@minus,<span class="var type1" id="S24T52U651">XTrainBag</span>,<span class="var type1" id="S54T51U652">muX</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,129" id="srcline129">129</a></span><span class="line">    <span class="mxinfo" id="T52:U396"><span class="var type1" id="S25T52U655">YTrainBag</span> = <span class="mxinfo" id="T52:U398">bsxfun(@minus,<span class="var type1" id="S25T60U660">YTrainBag</span>,<span class="var type1" id="S55T51U661">muY</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,130" id="srcline130">130</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,131" id="srcline131">131</a></span><span class="line">    <span class="mxinfo" id="T4:U401">[<span class="var type1" id="S57T4U665">x1</span>,<span class="var type1" id="S58T4U666">x2</span>] = size(<span class="var type1" id="S24T52U669">XTrainBag</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,132" id="srcline132">132</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U405"><span class="mxinfo" id="T4:U406">size(<span class="var type1" id="S25T52U675">YTrainBag</span>,1)</span> ~= <span class="var type1" id="S57T4U677">x1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,133" id="srcline133">133</a></span><span class="line">        error(<span class="string">'Input sizes do not match'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="184,134" id="srcline134">134</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo" id="T6:U409"><span class="var type1" id="S57T4U684">x1</span> == <span class="mxinfo" id="T4:U411">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,135" id="srcline135">135</a></span><span class="line">        error(<span class="string">'Cannot carry out component analysis with only one point'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="184,136" id="srcline136">136</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo" id="T4:U412"><span class="var type1" id="S60T4U692">K</span> = <span class="mxinfo" id="T4:U414">size(<span class="var type1" id="S25T52U695">YTrainBag</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,138" id="srcline138">138</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,139" id="srcline139">139</a></span><span class="line">    <span class="comment">% This code is a reduction of the function canoncorr.  This</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,140" id="srcline140">140</a></span><span class="line">    <span class="comment">% method is explained in the supplementary material</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo" id="T52:U416">[<span class="var type1" id="S61T52U700">q1</span>,<span class="var type1" id="S62T52U701">r1</span>,<span class="var type1" id="S63T51U702">p1</span>] = qr(<span class="var type1" id="S24T52U705">XTrainBag</span>,0)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,142" id="srcline142">142</a></span><span class="line">    <span class="comment">% Reduce to full rank within some tolerance</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,143" id="srcline143">143</a></span><span class="line">    <span class="mxinfo" id="T4:U421"><span class="var type1" id="S65T4U709">rankX</span> = <span class="mxinfo" id="T4:U423">sum(<span class="mxinfo" id="T45:U424"><span class="mxinfo" id="T46:U425">abs(<span class="mxinfo" id="T46:U426">diag(<span class="var type1" id="S62T52U717">r1</span>)</span>)</span> &gt;= (<span class="mxinfo" id="T4:U428"><span class="mxinfo" id="T4:U429"><span class="var type1" id="S10T55U721">options</span>.epsilonCCA</span>*<span class="mxinfo" id="T4:U431">abs(<span class="mxinfo" id="T4:U432"><span class="var type1" id="S62T52U726">r1</span>(<span class="mxinfo" id="T4:U434">1</span>)</span>)</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,144" id="srcline144">144</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U435"><span class="var type1" id="S65T4U731">rankX</span> == <span class="mxinfo" id="T4:U437">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,145" id="srcline145">145</a></span><span class="line">        <span class="comment">%warning('X doesnt vary so component analysis fails');</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,146" id="srcline146">146</a></span><span class="line">        <span class="mxinfo" id="T46:U438"><span class="var type1" id="S5T46U735">projMat</span> = <span class="mxinfo" id="T46:U440">[<span class="mxinfo" id="T4:U441">1</span>;<span class="mxinfo" id="T46:U442">zeros(<span class="mxinfo" id="T4:U443"><span class="mxinfo" id="T4:U444">size(<span class="var type1" id="S24T52U745">XTrainBag</span>,2)</span>-<span class="mxinfo" id="T4:U446">1</span></span>,1)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,147" id="srcline147">147</a></span><span class="line">        <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,148" id="srcline148">148</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo" id="T6:U447"><span class="var type1" id="S65T4U752">rankX</span> &lt; <span class="var type1" id="S58T4U753">x2</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,149" id="srcline149">149</a></span><span class="line">        <span class="mxinfo" id="T52:U450"><span class="var type1" id="S61T52U756">q1</span> = <span class="mxinfo" id="T148:U452"><span class="var type1" id="S61T52U758">q1</span>(:,<span class="mxinfo" id="T6:U454"><span class="mxinfo" id="T4:U455">1</span>:<span class="var type1" id="S65T4U762">rankX</span></span>)</span></span>; <span class="mxinfo" id="T52:U457"><span class="var type1" id="S62T52U765">r1</span> = <span class="mxinfo" id="T52:U459"><span class="var type1" id="S62T52U767">r1</span>(<span class="mxinfo" id="T6:U461"><span class="mxinfo" id="T4:U462">1</span>:<span class="var type1" id="S65T4U770">rankX</span></span>,<span class="mxinfo" id="T6:U464"><span class="mxinfo" id="T4:U465">1</span>:<span class="var type1" id="S65T4U773">rankX</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,150" id="srcline150">150</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,151" id="srcline151">151</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,152" id="srcline152">152</a></span><span class="line">    <span class="comment">% This code is a reduction of the function canoncorr.  This</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,153" id="srcline153">153</a></span><span class="line">    <span class="comment">% method is explained in the supplementary material</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,154" id="srcline154">154</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,155" id="srcline155">155</a></span><span class="line">    <span class="mxinfo" id="T52:U467">[<span class="var type1" id="S67T52U777">q2</span>,<span class="var type1" id="S68T52U778">r2</span>,<span class="mxinfo" id="T4:U470"><span class="mxinfo" id="T4:U471">~</span></span>] = qr(<span class="var type1" id="S25T52U782">YTrainBag</span>,0)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,156" id="srcline156">156</a></span><span class="line">    <span class="comment">% Reduce to full rank within some tolerance</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,157" id="srcline157">157</a></span><span class="line">    <span class="mxinfo" id="T4:U473"><span class="var type1" id="S69T4U786">rankY</span> = <span class="mxinfo" id="T4:U475">sum(<span class="mxinfo" id="T45:U476"><span class="mxinfo" id="T46:U477">abs(<span class="mxinfo" id="T46:U478">diag(<span class="var type1" id="S68T52U794">r2</span>)</span>)</span> &gt;= (<span class="mxinfo" id="T4:U480"><span class="mxinfo" id="T4:U481"><span class="var type1" id="S10T55U798">options</span>.epsilonCCA</span>*<span class="mxinfo" id="T4:U483">abs(<span class="mxinfo" id="T4:U484"><span class="var type1" id="S68T52U803">r2</span>(<span class="mxinfo" id="T4:U486">1</span>)</span>)</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,158" id="srcline158">158</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U487"><span class="var type1" id="S69T4U808">rankY</span> == <span class="mxinfo" id="T4:U489">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,159" id="srcline159">159</a></span><span class="line">        <span class="comment">%warning('Y doesnt vary so component analysis fails');</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,160" id="srcline160">160</a></span><span class="line">        <span class="mxinfo" id="T46:U490"><span class="var type1" id="S5T46U812">projMat</span> = <span class="mxinfo" id="T46:U492">[<span class="mxinfo" id="T4:U493">1</span>;<span class="mxinfo" id="T46:U494">zeros(<span class="mxinfo" id="T4:U495"><span class="mxinfo" id="T4:U496">size(<span class="var type1" id="S24T52U822">XTrainBag</span>,2)</span>-<span class="mxinfo" id="T4:U498">1</span></span>,1)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,161" id="srcline161">161</a></span><span class="line">        <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,162" id="srcline162">162</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo" id="T6:U499"><span class="var type1" id="S69T4U829">rankY</span> &lt; <span class="var type1" id="S60T4U830">K</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,163" id="srcline163">163</a></span><span class="line">        <span class="mxinfo" id="T52:U502"><span class="var type1" id="S67T52U833">q2</span> = <span class="mxinfo" id="T148:U504"><span class="var type1" id="S67T52U835">q2</span>(:,<span class="mxinfo" id="T6:U506"><span class="mxinfo" id="T4:U507">1</span>:<span class="var type1" id="S69T4U839">rankY</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,164" id="srcline164">164</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,165" id="srcline165">165</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,166" id="srcline166">166</a></span><span class="line">    <span class="comment">% Solve CCA using the decompositions</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,167" id="srcline167">167</a></span><span class="line">    <span class="mxinfo" id="T4:U509"><span class="var type1" id="S70T4U842">d</span> = <span class="mxinfo" id="T4:U511">min(<span class="var type1" id="S65T4U845">rankX</span>,<span class="var type1" id="S69T4U846">rankY</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,168" id="srcline168">168</a></span><span class="line">    <span class="mxinfo" id="T52:U514">[<span class="var type1" id="S71T52U850">L</span>,<span class="mxinfo" id="T4:U516"><span class="mxinfo" id="T4:U517">~</span></span>,<span class="mxinfo" id="T4:U518"><span class="mxinfo" id="T4:U519">~</span></span>] = svd(<span class="mxinfo" id="T52:U520"><span class="mxinfo" id="T52:U521"><span class="var type1" id="S61T52U857">q1</span>'</span> * <span class="var type1" id="S67T52U858">q2</span></span>,0)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo" id="T52:U524"><span class="var type1" id="S5T52U862">projMat</span> = <span class="mxinfo" id="T52:U526"><span class="mxinfo" id="T52:U527"><span class="var type1" id="S62T52U865">r1</span> \ <span class="mxinfo" id="T52:U529"><span class="var type1" id="S71T52U867">L</span>(:,<span class="mxinfo" id="T6:U531"><span class="mxinfo" id="T4:U532">1</span>:<span class="var type1" id="S70T4U871">d</span></span>)</span></span> * <span class="mxinfo" id="T4:U534">sqrt(<span class="mxinfo" id="T4:U535"><span class="var type1" id="S57T4U875">x1</span>-<span class="mxinfo" id="T4:U537">1</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,170" id="srcline170">170</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,171" id="srcline171">171</a></span><span class="line">    <span class="comment">% Put coefficients back to their full size and their correct order</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,172" id="srcline172">172</a></span><span class="line">    <span class="mxinfo" id="T52:U538"><span class="mxinfo" id="T52:U539"><span class="var type1" id="S5T52U880">projMat</span>(<span class="var type1" id="S63T51U881">p1</span>,:)</span> = <span class="mxinfo" id="T52:U542">[<span class="var type1" id="S5T52U885">projMat</span>; <span class="mxinfo" id="T118:U544">zeros(<span class="mxinfo" id="T4:U545"><span class="var type1" id="S58T4U890">x2</span>-<span class="var type1" id="S65T4U891">rankX</span></span>,<span class="var type1" id="S70T4U892">d</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,173" id="srcline173">173</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,174" id="srcline174">174</a></span><span class="line">    <span class="comment">% Normalize the projection matrices.  This ensures that the later tests for</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,175" id="srcline175">175</a></span><span class="line">    <span class="comment">% close points are triggered appropriately and is useful for</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,176" id="srcline176">176</a></span><span class="line">    <span class="comment">% interpretability.</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,177" id="srcline177">177</a></span><span class="line">    <span class="mxinfo" id="T52:U549"><span class="var type1" id="S5T52U895">projMat</span> = <span class="mxinfo" id="T52:U551">bsxfun(@rdivide,<span class="var type1" id="S5T52U900">projMat</span>,<span class="mxinfo" id="T51:U553">sqrt(<span class="mxinfo" id="T51:U554">sum(<span class="mxinfo" id="T52:U555"><span class="var type1" id="S5T52U906">projMat</span>.^2</span>,1)</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,178" id="srcline178">178</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,179" id="srcline179">179</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,180" id="srcline180">180</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,181" id="srcline181">181</a></span><span class="line">    <span class="comment">%% Choose the features to use</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,182" id="srcline182">182</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,183" id="srcline183">183</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U557"><span class="var type1" id="S10T55U912">options</span>.includeOriginalAxes</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,184" id="srcline184">184</a></span><span class="line">        <span class="mxinfo" id="T52:U559"><span class="var type1" id="S5T52U916">projMat</span> = <span class="mxinfo" id="T52:U561">[<span class="var type1" id="S5T52U919">projMat</span>,<span class="mxinfo" id="T52:U563">eye(<span class="mxinfo" id="T4:U564">size(<span class="var type1" id="S5T52U924">projMat</span>,1)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,185" id="srcline185">185</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,186" id="srcline186">186</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,187" id="srcline187">187</a></span><span class="line">    <span class="mxinfo" id="T52:U566"><span class="var type1" id="S76T52U928">UTrain</span> = <span class="mxinfo" id="T52:U568"><span class="mxinfo" id="T52:U569"><span class="var type1" id="S8T52U931">XTrain</span>(:,<span class="var type1" id="S7T51U933">iIn</span>)</span>*<span class="var type1" id="S5T52U934">projMat</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,188" id="srcline188">188</a></span><span class="line">    <span class="comment">% This step catches splits based on no significant variation</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,189" id="srcline189">189</a></span><span class="line">    <span class="mxinfo" id="T73:U573"><span class="var type1" id="S77T73U937">bUTrainVaries</span> = <span class="mxinfo" id="T73:U575"><span class="fcn" id="F380N8:B939">queryIfColumnsVary</span>(<span class="var type1" id="S76T52U940">UTrain</span>,<span class="mxinfo" id="T4:U577"><span class="var type1" id="S10T55U942">options</span>.XVariationTol</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,190" id="srcline190">190</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,191" id="srcline191">191</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U579">~<span class="mxinfo" id="T6:U580">any(<span class="var type1" id="S77T73U949">bUTrainVaries</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,192" id="srcline192">192</a></span><span class="line">        <span class="mxinfo" id="T6:U582"><span class="var type1" id="S2T6U952">bLeaf</span> = <span class="mxinfo" id="T6:U584">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,193" id="srcline193">193</a></span><span class="line">        <span class="mxinfo" id="T4:U585"><span class="var type1" id="S78T4U957">nProjDirs</span> = <span class="mxinfo" id="T4:U587">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,194" id="srcline194">194</a></span><span class="line">        <span class="mxinfo" id="T46:U588"><span class="var type1" id="S79T46U961">splitGains</span> = <span class="mxinfo" id="T38:U590"><span class="mxinfo" id="T4:U591">-inf</span>*ones(<span class="var type1" id="S78T4U968">nProjDirs</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,195" id="srcline195">195</a></span><span class="line">        <span class="mxinfo" id="T46:U593"><span class="var type1" id="S82T46U972">iSplits</span> = <span class="mxinfo" id="T38:U595">zeros(<span class="mxinfo" id="T4:U596"><span class="var type1" id="S78T4U975">nProjDirs</span></span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,196" id="srcline196">196</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,197" id="srcline197">197</a></span><span class="line">        <span class="mxinfo" id="T52:U598"><span class="var type1" id="S76T52U980">UTrain</span> = <span class="mxinfo" id="T52:U600"><span class="var type1" id="S76T52U982">UTrain</span>(:,<span class="var type1" id="S77T73U984">bUTrainVaries</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,198" id="srcline198">198</a></span><span class="line">        <span class="mxinfo" id="T52:U603"><span class="var type1" id="S5T52U987">projMat</span> = <span class="mxinfo" id="T52:U605"><span class="var type1" id="S5T52U989">projMat</span>(:,<span class="var type1" id="S77T73U991">bUTrainVaries</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,199" id="srcline199">199</a></span><span class="line">        <span class="mxinfo" id="T4:U608"><span class="var type1" id="S78T4U994">nProjDirs</span> = <span class="mxinfo" id="T4:U610">size(<span class="var type1" id="S76T52U997">UTrain</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,200" id="srcline200">200</a></span><span class="line">        <span class="mxinfo" id="T46:U612"><span class="var type1" id="S79T46U1001">splitGains</span> = <span class="mxinfo" id="T46:U614">NaN(<span class="var type1" id="S78T4U1004">nProjDirs</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,201" id="srcline201">201</a></span><span class="line">        <span class="mxinfo" id="T46:U616"><span class="var type1" id="S82T46U1008">iSplits</span> = <span class="mxinfo" id="T46:U618">NaN(<span class="var type1" id="S78T4U1011">nProjDirs</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,202" id="srcline202">202</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,203" id="srcline203">203</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,204" id="srcline204">204</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,205" id="srcline205">205</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,206" id="srcline206">206</a></span><span class="line">    <span class="comment">%% Search over splits using provided method</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,207" id="srcline207">207</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,208" id="srcline208">208</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S83T4U1015">nVarAtt</span> = <span class="mxinfo" id="T4:U621">1</span>:<span class="var type1" id="S78T4U1018">nProjDirs</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,209" id="srcline209">209</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,210" id="srcline210">210</a></span><span class="line">        <span class="comment">% Calculate the probabilities of being at each class in each of child</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,211" id="srcline211">211</a></span><span class="line">        <span class="comment">% nodes based on proportion of training data for each of possible</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,212" id="srcline212">212</a></span><span class="line">        <span class="comment">% splits using current projection</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,213" id="srcline213">213</a></span><span class="line">        <span class="mxinfo" id="T46:U623">[<span class="var type1" id="S84T46U1022">UTrainSort</span>,<span class="var type1" id="S85T46U1023">iUTrainSort</span>] = sort(<span class="mxinfo" id="T46:U626"><span class="var type1" id="S76T52U1027">UTrain</span>(:,<span class="var type1" id="S83T4U1029">nVarAtt</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,214" id="srcline214">214</a></span><span class="line">        <span class="mxinfo" id="T1:U629"><span class="var type1" id="S86T1U1032">YTrainSort</span> = <span class="mxinfo" id="T1:U631"><span class="var type1" id="S9T1U1034">YTrain</span>(<span class="var type1" id="S85T46U1035">iUTrainSort</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,215" id="srcline215">215</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T6:U634"><span class="mxinfo" id="T4:U635">size(<span class="var type1" id="S9T1U1042">YTrain</span>,2)</span>==<span class="mxinfo" id="T4:U637">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,216" id="srcline216">216</a></span><span class="line">            <span class="mxinfo" id="T109:U638"><span class="var type1" id="S87T109U1047">LeftCumCounts</span> = <span class="mxinfo" id="T109:U640">[<span class="mxinfo" id="T46:U641"><span class="mxinfo" id="T46:U642">(<span class="mxinfo" id="T51:U643">1:<span class="mxinfo" id="T4:U644">numel(<span class="var type1" id="S86T1U1057">YTrainSort</span>)</span></span>)'</span>-<span class="mxinfo" id="T101:U646">cumsum(<span class="var type1" id="S86T1U1060">YTrainSort</span>)</span></span>,<span class="mxinfo" id="T101:U648">cumsum(<span class="var type1" id="S86T1U1063">YTrainSort</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,217" id="srcline217">217</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,218" id="srcline218">218</a></span><span class="line">            <span class="mxinfo" id="T109:U650"><span class="var type1" id="S87T109U1067">LeftCumCounts</span> = <span class="mxinfo" id="T101:U652">cumsum(<span class="var type1" id="S86T1U1070">YTrainSort</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,219" id="srcline219">219</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,220" id="srcline220">220</a></span><span class="line">        <span class="mxinfo" id="T109:U654"><span class="var type1" id="S89T109U1074">RightCumCounts</span> = <span class="mxinfo" id="T109:U656">bsxfun(@minus,<span class="mxinfo" id="T119:U657"><span class="var type1" id="S87T109U1080">LeftCumCounts</span>(<span class="mxinfo" id="T4:U659">end</span>,:)</span>,<span class="var type1" id="S87T109U1084">LeftCumCounts</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,221" id="srcline221">221</a></span><span class="line">        <span class="mxinfo" id="T45:U661"><span class="var type1" id="S91T45U1087">bUniquePoints</span> = <span class="mxinfo" id="T45:U663">[<span class="mxinfo" id="T45:U664"><span class="mxinfo" id="T46:U665">diff(<span class="var type1" id="S84T46U1093">UTrainSort</span>,[],1)</span>&gt;<span class="mxinfo" id="T4:U667"><span class="var type1" id="S10T55U1098">options</span>.XVariationTol</span></span>;<span class="mxinfo" id="T6:U669">false</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,222" id="srcline222">222</a></span><span class="line">        <span class="mxinfo" id="T109:U670"><span class="var type1" id="S93T109U1105">pL</span> = <span class="mxinfo" id="T109:U672">bsxfun(@rdivide,<span class="var type1" id="S87T109U1110">LeftCumCounts</span>,<span class="mxinfo" id="T46:U674">sum(<span class="var type1" id="S87T109U1113">LeftCumCounts</span>,2)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,223" id="srcline223">223</a></span><span class="line">        <span class="mxinfo" id="T109:U676"><span class="var type1" id="S94T109U1117">pR</span> = <span class="mxinfo" id="T109:U678">bsxfun(@rdivide,<span class="var type1" id="S89T109U1122">RightCumCounts</span>,<span class="mxinfo" id="T46:U680">sum(<span class="var type1" id="S89T109U1125">RightCumCounts</span>,2)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,224" id="srcline224">224</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,225" id="srcline225">225</a></span><span class="line">        <span class="comment">% Calculate the metric values of the current node and two child nodes</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,226" id="srcline226">226</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T6:U682">strcmpi(<span class="mxinfo" id="T56:U683"><span class="var type1" id="S10T55U1132">options</span>.splitCriterion</span>,<span class="string">'gini'</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,227" id="srcline227">227</a></span><span class="line">            <span class="mxinfo" id="T46:U685"><span class="var type1" id="S96T46U1137">metricLeft</span> = <span class="mxinfo" id="T46:U687"><span class="mxinfo" id="T4:U688">1</span>-<span class="mxinfo" id="T46:U689">sum(<span class="mxinfo" id="T52:U690"><span class="var type1" id="S93T109U1143">pL</span>.^2</span>,2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,228" id="srcline228">228</a></span><span class="line">            <span class="mxinfo" id="T46:U692"><span class="var type1" id="S97T46U1148">metricRight</span> = <span class="mxinfo" id="T46:U694"><span class="mxinfo" id="T4:U695">1</span>-<span class="mxinfo" id="T46:U696">sum(<span class="mxinfo" id="T52:U697"><span class="var type1" id="S94T109U1154">pR</span>.^2</span>,2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,229" id="srcline229">229</a></span><span class="line">        <span class="keyword">elseif</span> <span class="mxinfo" id="T6:U699">strcmpi(<span class="mxinfo" id="T56:U700"><span class="var type1" id="S10T55U1161">options</span>.splitCriterion</span>,<span class="string">'info'</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,230" id="srcline230">230</a></span><span class="line">            <span class="mxinfo" id="T109:U702"><span class="var type1" id="S98T109U1166">pLProd</span> = <span class="mxinfo" id="T109:U704"><span class="var type1" id="S93T109U1168">pL</span>.*<span class="mxinfo" id="T109:U706">log2(<span class="var type1" id="S93T109U1171">pL</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,231" id="srcline231">231</a></span><span class="line">            <span class="mxinfo" id="T46:U708"><span class="mxinfo" id="T46:U709"><span class="var type1" id="S98T109U1175">pLProd</span>(<span class="mxinfo" id="T120:U711"><span class="var type1" id="S93T109U1177">pL</span>==<span class="mxinfo" id="T4:U713">0</span></span>)</span> = <span class="mxinfo" id="T4:U714">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,232" id="srcline232">232</a></span><span class="line">            <span class="mxinfo" id="T46:U715"><span class="var type1" id="S96T46U1182">metricLeft</span> = <span class="mxinfo" id="T46:U717">-<span class="mxinfo" id="T46:U718">sum(<span class="var type1" id="S98T109U1186">pLProd</span>,2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,233" id="srcline233">233</a></span><span class="line">            <span class="mxinfo" id="T109:U720"><span class="var type1" id="S100T109U1190">pRProd</span> = <span class="mxinfo" id="T109:U722"><span class="var type1" id="S94T109U1192">pR</span>.*<span class="mxinfo" id="T109:U724">log2(<span class="var type1" id="S94T109U1195">pR</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,234" id="srcline234">234</a></span><span class="line">            <span class="mxinfo" id="T46:U726"><span class="mxinfo" id="T46:U727"><span class="var type1" id="S100T109U1199">pRProd</span>(<span class="mxinfo" id="T120:U729"><span class="var type1" id="S94T109U1201">pR</span>==<span class="mxinfo" id="T4:U731">0</span></span>)</span> = <span class="mxinfo" id="T4:U732">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,235" id="srcline235">235</a></span><span class="line">            <span class="mxinfo" id="T46:U733"><span class="var type1" id="S97T46U1206">metricRight</span> = <span class="mxinfo" id="T46:U735">-<span class="mxinfo" id="T46:U736">sum(<span class="var type1" id="S100T109U1210">pRProd</span>,2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,236" id="srcline236">236</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,237" id="srcline237">237</a></span><span class="line">            <span class="mxinfo" id="T46:U738"><span class="var type1" id="S96T46U1215">metricLeft</span> = <span class="mxinfo" id="T46:U740">zeros(<span class="mxinfo" id="T4:U741">size(<span class="var type1" id="S93T109U1220">pL</span>,1)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,238" id="srcline238">238</a></span><span class="line">            <span class="mxinfo" id="T46:U743"><span class="var type1" id="S97T46U1225">metricRight</span> = <span class="mxinfo" id="T46:U745">zeros(<span class="mxinfo" id="T4:U746">size(<span class="var type1" id="S93T109U1230">pL</span>,1)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,239" id="srcline239">239</a></span><span class="line">            error(<span class="string">'Invalid split criterion'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="184,240" id="srcline240">240</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,241" id="srcline241">241</a></span><span class="line">        <span class="mxinfo" id="T4:U748"><span class="var type1" id="S101T4U1239">metricCurrent</span> = <span class="mxinfo" id="T4:U750"><span class="var type1" id="S96T46U1241">metricLeft</span>(<span class="mxinfo" id="T4:U752">end</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,242" id="srcline242">242</a></span><span class="line">        <span class="mxinfo" id="T46:U753"><span class="mxinfo" id="T46:U754"><span class="var type1" id="S96T46U1247">metricLeft</span>(<span class="mxinfo" id="T45:U756">~<span class="var type1" id="S91T45U1249">bUniquePoints</span></span>)</span> = <span class="mxinfo" id="T4:U758">inf</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,243" id="srcline243">243</a></span><span class="line">        <span class="mxinfo" id="T46:U759"><span class="mxinfo" id="T46:U760"><span class="var type1" id="S97T46U1255">metricRight</span>(<span class="mxinfo" id="T45:U762">~<span class="var type1" id="S91T45U1257">bUniquePoints</span></span>)</span> = <span class="mxinfo" id="T4:U764">inf</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,244" id="srcline244">244</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,245" id="srcline245">245</a></span><span class="line">        <span class="comment">% Calculate gain in metric for each of possible splits based on current</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,246" id="srcline246">246</a></span><span class="line">        <span class="comment">% metric value minus metric value of child weighted by number of terms</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,247" id="srcline247">247</a></span><span class="line">        <span class="comment">% in each child</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,248" id="srcline248">248</a></span><span class="line">        <span class="mxinfo" id="T46:U765"><span class="var type1" id="S102T46U1262">metricGain</span> = <span class="mxinfo" id="T46:U767"><span class="var type1" id="S101T4U1264">metricCurrent</span>-<span class="mxinfo" id="T46:U769">(<span class="mxinfo" id="T46:U770"><span class="mxinfo" id="T46:U771"><span class="mxinfo" id="T46:U772">(<span class="mxinfo" id="T51:U773">1:<span class="var type1" id="S18T4U1273">N</span></span>)'</span>.*<span class="var type1" id="S96T46U1274">metricLeft</span></span>+<span class="mxinfo" id="T46:U776"><span class="mxinfo" id="T46:U777">(<span class="mxinfo" id="T51:U778"><span class="mxinfo" id="T4:U779"><span class="var type1" id="S18T4U1281">N</span>-<span class="mxinfo" id="T4:U781">1</span></span>:-1:0</span>)'</span>.*<span class="var type1" id="S97T46U1286">metricRight</span></span></span>)/<span class="var type1" id="S18T4U1287">N</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,249" id="srcline249">249</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,250" id="srcline250">250</a></span><span class="line">        <span class="comment">% Randomly sample from equally best splits</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,251" id="srcline251">251</a></span><span class="line">        <span class="mxinfo" id="T4:U784">[<span class="var type1" id="S79T46U1292">splitGains</span>(<span class="var type1" id="S83T4U1293">nVarAtt</span>),<span class="var type1" id="S82T46U1295">iSplits</span>(<span class="var type1" id="S83T4U1296">nVarAtt</span>)] = max(<span class="mxinfo" id="T46:U789"><span class="var type1" id="S102T46U1300">metricGain</span>(<span class="mxinfo" id="T4:U791">1</span>:<span class="mxinfo" id="T4:U792"><span class="mxinfo" id="T4:U793">end</span>-<span class="mxinfo" id="T4:U794">1</span></span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,252" id="srcline252">252</a></span><span class="line">        <span class="mxinfo" id="T46:U795"><span class="var type1" id="S103T46U1309">iEqualMax</span> = <span class="mxinfo" id="T46:U797">find(<span class="mxinfo" id="T45:U798"><span class="mxinfo" id="T46:U799">abs(<span class="mxinfo" id="T46:U800"><span class="mxinfo" id="T46:U801"><span class="var type1" id="S102T46U1317">metricGain</span>(<span class="mxinfo" id="T4:U803">1</span>:<span class="mxinfo" id="T4:U804"><span class="mxinfo" id="T4:U805">end</span>-<span class="mxinfo" id="T4:U806">1</span></span>)</span>-<span class="mxinfo" id="T4:U807"><span class="var type1" id="S79T46U1325">splitGains</span>(<span class="var type1" id="S83T4U1326">nVarAtt</span>)</span></span>)</span>&lt;(<span class="mxinfo" id="T4:U810"><span class="mxinfo" id="T4:U811">10</span>*<span class="mxinfo" id="T4:U812">eps</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,253" id="srcline253">253</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T6:U813">isempty(<span class="var type1" id="S103T46U1336">iEqualMax</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,254" id="srcline254">254</a></span><span class="line">            <span class="mxinfo" id="T46:U815"><span class="var type1" id="S103T46U1339">iEqualMax</span> = <span class="mxinfo" id="T4:U817">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,255" id="srcline255">255</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,256" id="srcline256">256</a></span><span class="line">        <span class="mxinfo" id="T4:U818"><span class="mxinfo" id="T4:U819"><span class="var type1" id="S82T46U1344">iSplits</span>(<span class="var type1" id="S83T4U1345">nVarAtt</span>)</span> = <span class="mxinfo" id="T4:U822"><span class="var type1" id="S103T46U1347">iEqualMax</span>(<span class="mxinfo" id="T4:U824">randi(<span class="mxinfo" id="T4:U825">numel(<span class="var type1" id="S103T46U1352">iEqualMax</span>)</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,257" id="srcline257">257</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,258" id="srcline258">258</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,259" id="srcline259">259</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,260" id="srcline260">260</a></span><span class="line">    <span class="comment">% If no split gives a positive gain then stop</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,261" id="srcline261">261</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U827"><span class="mxinfo" id="T4:U828">max(<span class="var type1" id="S79T46U1358">splitGains</span>)</span>&lt;<span class="mxinfo" id="T4:U830">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="184,262" id="srcline262">262</a></span><span class="line">        <span class="mxinfo" id="T6:U831"><span class="var type1" id="S2T6U1362">bLeaf</span> = <span class="mxinfo" id="T6:U833">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,263" id="srcline263">263</a></span><span class="line">        <span class="mxinfo" id="T105:U834"><span class="var type1" id="S3T105U1367">bLessThanTrain</span> = <span class="mxinfo" id="T66:U836"><span class="mxinfo" id="T6:U837">false</span>(<span class="mxinfo" id="T4:U838">0</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,264" id="srcline264">264</a></span><span class="line">        <span class="mxinfo" id="T106:U839"><span class="var type1" id="S4T106U1374">partitionPoint</span> = <span class="mxinfo" id="T4:U841">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,265" id="srcline265">265</a></span><span class="line">        <span class="mxinfo" id="T52:U842"><span class="var type1" id="S5T52U1378">projMat</span> = <span class="mxinfo" id="T46:U844">zeros(<span class="mxinfo" id="T4:U845">size(<span class="var type1" id="S8T52U1383">XTrain</span>,2)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,266" id="srcline266">266</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,267" id="srcline267">267</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,268" id="srcline268">268</a></span><span class="line">        <span class="comment">% Establish between projection direction</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,269" id="srcline269">269</a></span><span class="line">        <span class="mxinfo" id="T4:U847"><span class="var type1" id="S105T4U1389">maxGain</span> = <span class="mxinfo" id="T4:U849">max(<span class="var type1" id="S79T46U1392">splitGains</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,270" id="srcline270">270</a></span><span class="line">        <span class="mxinfo" id="T46:U851"><span class="var type1" id="S103T46U1395">iEqualMax</span> = <span class="mxinfo" id="T46:U853">find(<span class="mxinfo" id="T45:U854"><span class="mxinfo" id="T46:U855">abs(<span class="mxinfo" id="T46:U856"><span class="var type1" id="S79T46U1402">splitGains</span>-<span class="var type1" id="S105T4U1403">maxGain</span></span>)</span>&lt;(<span class="mxinfo" id="T4:U859"><span class="mxinfo" id="T4:U860">10</span>*<span class="mxinfo" id="T4:U861">eps</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,271" id="srcline271">271</a></span><span class="line">        <span class="comment">% Use given method to break ties</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,272" id="srcline272">272</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T6:U862">strcmpi(<span class="mxinfo" id="T56:U863"><span class="var type1" id="S10T55U1414">options</span>.dirIfEqual</span>,<span class="string">'rand'</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,273" id="srcline273">273</a></span><span class="line">            <span class="mxinfo" id="T4:U865"><span class="var type1" id="S52T4U1419">iDir</span> = <span class="mxinfo" id="T4:U867"><span class="var type1" id="S103T46U1421">iEqualMax</span>(<span class="mxinfo" id="T4:U869">randi(<span class="mxinfo" id="T4:U870">numel(<span class="var type1" id="S103T46U1426">iEqualMax</span>)</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,274" id="srcline274">274</a></span><span class="line">        <span class="keyword">elseif</span> <span class="mxinfo" id="T6:U872">strcmpi(<span class="mxinfo" id="T56:U873"><span class="var type1" id="S10T55U1431">options</span>.dirIfEqual</span>,<span class="string">'first'</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,275" id="srcline275">275</a></span><span class="line">            <span class="mxinfo" id="T4:U875"><span class="var type1" id="S52T4U1436">iDir</span> = <span class="mxinfo" id="T4:U877"><span class="var type1" id="S103T46U1438">iEqualMax</span>(<span class="mxinfo" id="T4:U879">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,276" id="srcline276">276</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,277" id="srcline277">277</a></span><span class="line">            error(<span class="string">'invalid dirIfEqual'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="184,278" id="srcline278">278</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,279" id="srcline279">279</a></span><span class="line">        <span class="mxinfo" id="T4:U880"><span class="var type1" id="S106T4U1447">iSplit</span> = <span class="mxinfo" id="T4:U882"><span class="var type1" id="S82T46U1449">iSplits</span>(<span class="var type1" id="S52T4U1450">iDir</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,280" id="srcline280">280</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,281" id="srcline281">281</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,282" id="srcline282">282</a></span><span class="line">        <span class="comment">%% Establish partition point and assign to child</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,283" id="srcline283">283</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,284" id="srcline284">284</a></span><span class="line">        <span class="mxinfo" id="T52:U885"><span class="var type1" id="S5T52U1453">projMat</span>=<span class="mxinfo" id="T46:U887"><span class="var type1" id="S5T52U1455">projMat</span>(:,<span class="mxinfo" id="T4:U889"><span class="var type1" id="S52T4U1458">iDir</span>(1)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,285" id="srcline285">285</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,286" id="srcline286">286</a></span><span class="line">        <span class="mxinfo" id="T46:U891"><span class="var type1" id="S76T46U1462">UTrain</span> = <span class="mxinfo" id="T46:U893"><span class="var type1" id="S76T52U1464">UTrain</span>(:,<span class="var type1" id="S52T4U1466">iDir</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,287" id="srcline287">287</a></span><span class="line">        <span class="mxinfo" id="T46:U896"><span class="var type1" id="S84T46U1469">UTrainSort</span> = <span class="mxinfo" id="T46:U898">sort(<span class="var type1" id="S76T46U1472">UTrain</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,288" id="srcline288">288</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,289" id="srcline289">289</a></span><span class="line">        <span class="comment">% The convoluted nature of the below is to avoid numerical errors</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,290" id="srcline290">290</a></span><span class="line">        <span class="mxinfo" id="T4:U900"><span class="var type1" id="S107T4U1475">uTrainSortLeftPart</span> = <span class="mxinfo" id="T4:U902"><span class="var type1" id="S84T46U1477">UTrainSort</span>(<span class="var type1" id="S106T4U1478">iSplit</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,291" id="srcline291">291</a></span><span class="line">        <span class="mxinfo" id="T46:U905"><span class="var type1" id="S84T46U1481">UTrainSort</span> = <span class="mxinfo" id="T46:U907"><span class="var type1" id="S84T46U1483">UTrainSort</span>-<span class="var type1" id="S107T4U1484">uTrainSortLeftPart</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,292" id="srcline292">292</a></span><span class="line">        <span class="mxinfo" id="T4:U910"><span class="var type1" id="S4T4U1487">partitionPoint</span> = <span class="mxinfo" id="T4:U912"><span class="mxinfo" id="T4:U913"><span class="mxinfo" id="T4:U914"><span class="var type1" id="S84T46U1491">UTrainSort</span>(<span class="var type1" id="S106T4U1492">iSplit</span>)</span>*<span class="mxinfo" id="T4:U917">0.5</span></span>+<span class="mxinfo" id="T4:U918"><span class="mxinfo" id="T4:U919"><span class="var type1" id="S84T46U1496">UTrainSort</span>(<span class="mxinfo" id="T4:U921"><span class="var type1" id="S106T4U1498">iSplit</span>+<span class="mxinfo" id="T4:U923">1</span></span>)</span>*<span class="mxinfo" id="T4:U924">0.5</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,293" id="srcline293">293</a></span><span class="line">        <span class="mxinfo" id="T106:U925"><span class="var type1" id="S4T106U1503">partitionPoint</span> = <span class="mxinfo" id="T4:U927"><span class="var type1" id="S4T4U1505">partitionPoint</span>+<span class="var type1" id="S107T4U1506">uTrainSortLeftPart</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,294" id="srcline294">294</a></span><span class="line">        <span class="mxinfo" id="T46:U930"><span class="var type1" id="S84T46U1509">UTrainSort</span> = <span class="mxinfo" id="T46:U932"><span class="var type1" id="S84T46U1511">UTrainSort</span>+<span class="var type1" id="S107T4U1512">uTrainSortLeftPart</span></span></span>; <span class="comment">%#ok&lt;NASGU&gt;</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,295" id="srcline295">295</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,296" id="srcline296">296</a></span><span class="line">        <span class="mxinfo" id="T105:U935"><span class="var type1" id="S3T105U1515">bLessThanTrain</span> = <span class="mxinfo" id="T45:U937"><span class="var type1" id="S76T46U1517">UTrain</span>&lt;=(<span class="mxinfo" id="T116:U939">repmat(<span class="var type1" id="S4T106U1521">partitionPoint</span>,<span class="mxinfo" id="T4:U941">size(<span class="var type1" id="S76T46U1524">UTrain</span>,1)</span>,1)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,297" id="srcline297">297</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="184,298" id="srcline298">298</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T6:U943">~<span class="mxinfo" id="T6:U944">any(<span class="mxinfo" id="T45:U945"><span class="var type1" id="S3T105U1534">bLessThanTrain</span>(:)</span>)</span></span> || <span class="mxinfo" id="T6:U947">all(<span class="mxinfo" id="T45:U948"><span class="var type1" id="S3T105U1539">bLessThanTrain</span>(:)</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,299" id="srcline299">299</a></span><span class="line">            error(<span class="string">'Suggested split with empty'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="184,300" id="srcline300">300</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,301" id="srcline301">301</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,302" id="srcline302">302</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,303" id="srcline303">303</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="184,304" id="srcline304">304</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="184,305" id="srcline305">305</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,306" id="srcline306">306</a></span><span class="line"><span class="mxinfo" id="T46:U950"><span class="var type1" id="S5T46U1547">projMat</span> = <span class="mxinfo" id="T46:U952"><span class="var type1" id="S5T52U1549">projMat</span>(:,<span class="mxinfo" id="T4:U954">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="184,307" id="srcline307">307</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="184,308" id="srcline308">308</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
